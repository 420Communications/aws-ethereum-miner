# Use this template if you wish to stand up the instances in a custom VPC

AWSTemplateFormatVersion: '2010-09-09'

Metadata:
  RepoUrl: https://github.com/mludvig/aws-ethereum-miner
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Miner Configuration
        Parameters:
        - EthWallet

      - Label:
          default: Instance Configuration
        Parameters:
        - InstanceType
        - InstanceCount
        - PricingPlan

      - Label:
          default: Networking Configuration
        Parameters:
        - VpcId
        - SubnetIds

Parameters:
  InstanceType:
    Type: String
    AllowedValues:
    ## The commented-out are not worth it - too slow for the price
    #- g3s.xlarge    # 1 GPU Tesla M60
    #- g3.8xlarge    # 2 GPU Tesla M60
    - g4dn.xlarge   # 1 GPU Tesla T4 -- best value (cost/performance)
    - g4dn.2xlarge  # 1 GPU Tesla T4
    - g4dn.12xlarge # 4 GPU Tesla T4
    - g4dn.metal    # 8 GPU Tesla T4
    - g5.xlarge     # 1 GPU Tesla A10g
    - g5.12xlarge   # 4 GPU Tesla A10g
    - g5.48xlarge   # 8 GPU Tesla A10g
    #- p2.xlarge     # 1 GPU Tesla K80
    #- p2.8xlarge    # 8 GPU Tesla K80
    #- p2.16xlarge   # 16 GPU Tesla K80
    - p3.2xlarge    # 1 GPU Tesla V100
    - p3.8xlarge    # 4 GPU Tesla V100
    - p3.16xlarge   # 8 GPU Tesla V100
    - p3dn.24xlarge # 8 GPU Tesla V100
    - p4d.24xlarge  # 8 GPU Tesla A100
    Default: g4dn.xlarge

  InstanceCount:
    Type: Number
    Default: 10

  EthWallet:
    Type: String
    Description: Ethereum Wallet Address
    Default: "0x99b36B44cf319c9E0ed4619ee2050B21ECac2c15"
    AllowedPattern: "0x[0-9a-fA-F]+"

  PricingPlan:
    Type: String
    Description: Spot or On-Demand
    AllowedValues:
    - spot
    - ondemand
    Default: spot

  VpcId:
    Description: The VPC where this stack will be deployed
    Type: AWS::EC2::VPC::Id

  SubnetIds:
    Description: The subnets where the instances will be deployed - at least 3 subnets!
    Type: List<AWS::EC2::Subnet::Id>

Conditions:
  UseSpot: !Equals [ !Ref PricingPlan, "spot" ]

Mappings:
  # ImageId of "cuda-11 2021-11-19T06-45-18.713Z" in each region
  RegionMap:
    ap-northeast-1:
      ImageId: ami-057223d0b465ef6c8
    ap-northeast-2:
      ImageId: ami-04974804b5c32ad3f
    ap-south-1:
      ImageId: ami-0138f84dea0009e24
    ap-southeast-1:
      ImageId: ami-028fec8125dca56aa
    ap-southeast-2:
      ImageId: ami-07b457617d5ab5026
    ca-central-1:
      ImageId: ami-00cbba349f2627bef
    eu-central-1:
      ImageId: ami-0527e1e1ca0929e8c
    eu-north-1:
      ImageId: ami-070fab14d346eec81
    eu-west-1:
      ImageId: ami-052dfb972e5a6cdd0
    eu-west-2:
      ImageId: ami-0126c804cd6d92090
    eu-west-3:
      ImageId: ami-0fe47281cdcb0102b
    sa-east-1:
      ImageId: ami-0ad6f33841de28c4c
    us-east-1:
      ImageId: ami-04822dc0e04836a86
    us-east-2:
      ImageId: ami-0b3cc42a259739f29
    us-west-1:
      ImageId: ami-00158baf36cd6ace7
    us-west-2:
      ImageId: ami-013f60ec8ba5a9ca4

  #SpotPriceMap:
  #  g4dn.xlarge:
  #    MaxPrice: 0.17
  #  g4dn.2xlarge:
  #    MaxPrice: 0.24
  #  g4dn.12xlarge:
  #    MaxPrice: 1.57
  #  p3.2xlarge:
  #    MaxPrice: 0.92
  #  p3.8xlarge:
  #    MaxPrice: 3.68
  #  p3.16xlarge:
  #    MaxPrice: 7.36
  #  p4d.24xlarge:
  #    MaxPrice: 10.0

Resources:

  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
      - !Ref InstanceRole

  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        IamInstanceProfile:
          Arn: !GetAtt InstanceProfile.Arn
        InstanceMarketOptions:
          Fn::If:
          - UseSpot
          - MarketType: spot
            SpotOptions:
              SpotInstanceType: one-time
              #MaxPrice: !FindInMap [ SpotPriceMap, !Ref InstanceType, MaxPrice ]
          - !Ref AWS::NoValue
        InstanceType: !Ref InstanceType
        ImageId: !FindInMap [ RegionMap, !Ref "AWS::Region", ImageId ]
        SecurityGroupIds:
        - !Ref SecurityGroup
        UserData:
          'Fn::Base64':
            'Fn::Sub': |
                #!/bin/bash -x
                cd /tmp
                wget -O ethminer.tar.gz https://ethminer-cuda.s3.amazonaws.com/0.19.0/ethminer-0.19.0-cuda-11-linux-x86_64.tar.gz
                tar xvfz ethminer.tar.gz
                cd bin
                cat > runner.sh << __EOF__
                #!/bin/bash -x
                SERVERS=(us1 us2 eu1 asia1)
                while (true); do
                  PREFERRED_SERVER=\${!SERVERS[\${!RANDOM} % \${!#SERVERS[@]}]}
                  ./ethminer \
                    -P stratums://${EthWallet}@\${!PREFERRED_SERVER}.ethermine.org:5555 \
                    -P stratums://${EthWallet}@us1.ethermine.org:5555 \
                    -P stratums://${EthWallet}@us2.ethermine.org:5555 \
                    -P stratums://${EthWallet}@eu1.ethermine.org:5555 \
                    -P stratums://${EthWallet}@asia1.ethermine.org:5555 \
                  >> /tmp/ethminer.log 2>&1
                done
                __EOF__
                chmod +x runner.sh
                nohup ./runner.sh &

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Ref AWS::StackName
      VpcId: !Ref VpcId
      SecurityGroupEgress:
      - IpProtocol: -1
        CidrIp: 0.0.0.0/0
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName

  MinerAsg:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 0
      MaxSize: !Ref InstanceCount
      DesiredCapacity: !Ref InstanceCount
      CapacityRebalance: false
      VPCZoneIdentifier: !Ref SubnetIds
      HealthCheckGracePeriod: 900
      HealthCheckType: EC2
      TerminationPolicies:
      - ClosestToNextInstanceHour
      NotificationConfigurations:
      - TopicARN: !Ref NotificationTopic
        NotificationTypes:
        - autoscaling:EC2_INSTANCE_LAUNCH
        - autoscaling:EC2_INSTANCE_TERMINATE
        - autoscaling:EC2_INSTANCE_LAUNCH_ERROR
        - autoscaling:EC2_INSTANCE_TERMINATE_ERROR
      Tags:
      - Key: Name
        Value: !Ref AWS::StackName
        PropagateAtLaunch: true

  NotificationTopic:
    Type: AWS::SNS::Topic

Outputs:
  NotificationTopic:
    Description: Monitoring notification topic
    Value: !Ref NotificationTopic

  DashboardUrl:
    Description: Ethermine Dashboard URL
    Value: !Sub "https://ethermine.org/miners/${EthWallet}/dashboard"
